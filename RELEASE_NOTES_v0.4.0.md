# Code-Switch v0.4.0 - 等级拉黑系统

## 🎯 核心新特性

### 📊 分级黑名单系统（Graduated Blacklist）

取代原有的固定时长拉黑机制，引入 **6 级黑名单系统（L0-L5）**，根据 provider 的失败历史动态调整拉黑时长：

| 等级 | 拉黑时长 | 触发条件 | 颜色标识 |
|------|---------|---------|---------|
| **L0** | 无拉黑 | 初始状态 / 已宽恕 | - |
| **L1** | 5 分钟 | 首次达到失败阈值 | 🟨 黄色 |
| **L2** | 15 分钟 | 第二次失败 | 🟧 橙黄 |
| **L3** | 1 小时 | 第三次失败 | 🟧 浅红 |
| **L4** | 6 小时 | 第四次失败 | 🟥 中红 |
| **L5** | 24 小时 | 第五次及以上 | 🟥 深红 |

### ⚡ 智能惩罚与恢复机制

**1. 跳级惩罚（Jump Penalty）**
- **短时间内复发**：Provider 从拉黑恢复后 **≤ 2.5 小时**再次失败 → **+2 级**
- **长时间后失败**：恢复后 **> 2.5 小时**失败 → **+1 级**（正常升级）
- 目的：严厉惩罚不稳定的 provider，保护用户体验

**2. 自动降级（Auto-Degrade）**
- 每稳定运行 **1 小时** → **-1 级**
- 逐步恢复 provider 信誉，给予"改过自新"机会

**3. 宽恕机制（Forgiveness）**
- 条件：**等级 ≥ L3** 且稳定运行 **3 小时**
- 效果：**直接清零到 L0**
- 目的：避免一次性故障导致永久惩罚

**4. 去重窗口（30 秒）**
- 防止 Claude Code 客户端自动重试导致误判
- 同一 provider 在 30 秒内的多次失败只计数一次

### 🎨 前端 UI 增强

**1. 等级徽章显示**
- 拉黑状态：显示等级徽章（L1-L5）+ 剩余时间倒计时
- 未拉黑但有等级：显示轻量化徽章 + "有失败记录"提示
- 颜色渐变：从黄色（L1）→ 深红（L5），直观反映严重程度
- 完整支持浅色/深色主题

**2. 双操作按钮**
- **完全解除**：解除拉黑 + 清零等级 + 重置降级计时器
- **清零等级**：仅重置等级到 L0，保留当前拉黑状态（用于测试或误触发场景）

**3. 国际化支持**
- 完整中英文翻译
- 详细的操作提示和倒计时显示

### 🔧 向后兼容

**功能开关**
- 默认 **关闭**（`enableLevelBlacklist: false`）
- 关闭时自动回退到固定拉黑模式：
  - `fallbackMode: "fixed"` → 使用固定时长拉黑（默认 30 分钟）
  - `fallbackMode: "none"` → 不拉黑，仅记录失败

**配置文件**
- 独立存储：`~/.code-switch/blacklist-config.json`
- 不影响现有配置文件结构

## 📋 完整配置说明

### 等级拉黑配置（默认值）

```json
{
  "enableLevelBlacklist": false,          // 是否启用等级拉黑
  "failureThreshold": 3,                   // 失败阈值（连续失败次数）
  "dedupeWindowSeconds": 30,               // 去重窗口（秒）
  "normalDegradeIntervalHours": 1.0,       // 正常降级间隔（小时）
  "forgivenessHours": 3.0,                 // 宽恕触发时间（小时）
  "jumpPenaltyWindowHours": 2.5,           // 跳级惩罚窗口（小时）
  "l1DurationMinutes": 5,                  // L1 拉黑时长
  "l2DurationMinutes": 15,                 // L2 拉黑时长
  "l3DurationMinutes": 60,                 // L3 拉黑时长
  "l4DurationMinutes": 360,                // L4 拉黑时长（6小时）
  "l5DurationMinutes": 1440,               // L5 拉黑时长（24小时）
  "fallbackMode": "fixed",                 // 关闭时的行为（fixed/none）
  "fallbackDurationMinutes": 30            // 固定拉黑时长
}
```

### 启用等级拉黑

编辑 `~/.code-switch/blacklist-config.json`，将 `enableLevelBlacklist` 改为 `true`。

## 🔍 使用场景示例

### 场景 1：不稳定的 Provider

```
09:00  Provider A 连续失败 3 次 → 拉黑至 L1（5 分钟）
09:05  自动恢复
09:10  再次失败 3 次 → 跳级惩罚（0.17h < 2.5h）→ L3（1 小时）
10:10  自动恢复
11:10  稳定 1 小时 → 降级到 L2
12:10  稳定 2 小时 → 降级到 L1
13:10  稳定 3 小时 → 触发宽恕 → L0（完全清零）
```

### 场景 2：偶发故障的 Provider

```
14:00  Provider B 失败 → L1（5 分钟）
14:05  恢复
17:00  稳定 3 小时后再次失败 → 正常升级（3h > 2.5h）→ L2（15 分钟）
17:15  恢复
18:15  降级到 L1
19:15  降级到 L0
```

## 🗂️ 数据库变更

新增字段：
```sql
blacklist_level INTEGER DEFAULT 0,          -- 当前黑名单等级 (0-5)
last_recovered_at DATETIME,                 -- 上次恢复时间
last_degrade_hour INTEGER DEFAULT 0,        -- 上次降级时刻（小时数）
last_failure_window_start DATETIME,         -- 去重窗口起始时间
```

**兼容性**：现有数据库会自动升级，旧记录默认 `blacklist_level = 0`。

## 📦 技术实现

### 后端（Go）
- **新增文件**：`services/blacklist_level_config.go`（配置管理）
- **重构文件**：
  - `services/blacklistservice.go`（核心逻辑重写）
  - `services/database.go`（数据库迁移）
  - `services/settingsservice.go`（配置结构扩展）
- **新增方法**：
  - `ManualUnblockAndReset()` - 完全解除拉黑
  - `ManualResetLevel()` - 仅清零等级
  - `getLevelDuration()` - 等级时长映射

### 前端（Vue）
- **UI 组件**：
  - 等级徽章（5 级颜色渐变）
  - 双操作按钮（主要/次要样式）
  - 独立等级徽章（未拉黑状态）
- **样式支持**：
  - 完整浅色/深色主题适配
  - 渐变色系统（L1 黄 → L5 红）
- **国际化**：
  - 中文/英文完整翻译
  - 详细操作提示

## 📊 版本对比

| 功能 | v0.3.x | v0.4.0 |
|------|--------|--------|
| 拉黑时长 | 固定（15/30/60 分钟） | 动态（5分钟～24小时） |
| 惩罚策略 | 单一阈值 | 分级 + 跳级惩罚 |
| 自动恢复 | 仅时间到期 | 降级 + 宽恕机制 |
| 去重保护 | ❌ | ✅ 30 秒窗口 |
| 手动操作 | 单一解禁 | 完全解除 / 清零等级 |
| UI 显示 | 简单倒计时 | 等级徽章 + 渐变色 |
| 配置复杂度 | 低（2 个参数） | 中（11 个参数，可选） |

## 🚀 升级指南

### 自动升级（推荐）
1. 下载对应平台的安装包
2. 覆盖安装
3. 数据库和配置自动迁移

### 手动升级
1. 备份配置文件（可选）：
   ```bash
   cp ~/.code-switch/app.db ~/.code-switch/app.db.backup
   ```
2. 安装新版本
3. 首次启动时自动执行数据库迁移

## ⚠️ 注意事项

1. **默认行为**：等级拉黑功能默认 **关闭**，升级后行为与 v0.3.x 一致
2. **性能影响**：新增的降级和宽恕逻辑在每次成功请求时触发，但计算开销极小（< 1ms）
3. **配置文件**：首次启动时会自动创建 `~/.code-switch/blacklist-config.json`
4. **数据迁移**：旧版本的黑名单记录会保留，等级字段初始化为 0

## 🐛 已知问题

暂无

## 📝 未来计划

- [ ] 配置面板 UI（在设置页面可视化配置等级拉黑参数）
- [ ] 黑名单历史记录查看
- [ ] 导出黑名单统计报告

## 👥 贡献者

Half open flowers

---

**完整更新日志**：[v0.4.0 Commits](https://github.com/Rogers-F/code-switch-R/compare/v0.3.7...v0.4.0)
