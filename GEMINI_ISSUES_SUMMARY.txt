========================================
Gemini 实现问题汇总 (cc-r vs cc-switch)
========================================

分析对象：
- 参考项目：G:\claude-lit\cc-sw\cc-switch (Rust/Tauri)
- 当前项目：G:\claude-lit\cc-r (Go/Wails3)

分析日期：2025-11-29

========================================
P0 优先级（阻断问题）
========================================

【问题1】测试函数参数缺失
- 文件：services/geminiservice_test.go
- 行号：8, 233
- 现象：NewGeminiService() 调用缺少必需的 relayAddr 参数
- 影响：go test ./... 编译失败
- 修复：添加 ":18100" 参数

【问题2】SwitchProvider() 缺少配置验证
- 文件：services/geminiservice.go
- 方法：SwitchProvider()（行195-271）
- 现象：切换到配置不完整的供应商时无验证
- 影响：用户可切换到无API Key的供应商，导致Gemini读取失败
- 修复：在写入配置前验证必需字段（如 API Key）
- 参考：cc-switch 的 validate_gemini_settings_strict()

========================================
P1 优先级（配置错误）
========================================

【问题3】备份文件命名错误
- 文件：services/geminiservice.go
- 行号：656, 689
- 问题：".cc-studio.backup" → 应为 ".cc-switch.backup" 或 ".code-switch.backup"
- 影响：禁用代理时无法正确恢复备份（会丢失原配置）
- 工作量：1 分钟（简单替换）

【问题4】认证类型 selectedType 值不准确
- 文件：services/geminiservice.go
- 行号：232-262（SwitchProvider 中的 switch 语句）
- 问题：所有 API Key 认证都写 "gemini-api-key"，无法区分 PackyCode
- 当前代码：
  case GeminiAuthPackycode, GeminiAuthAPIKey, GeminiAuthGeneric:
      // 都写成 selectedType: "gemini-api-key"
- 修复：按类型区分
  case GeminiAuthPackycode:
      selectedType: "packycode"
  case GeminiAuthAPIKey:
      selectedType: "gemini-api-key"
- 工作量：10 分钟

【问题5】envConfig 处理丢失预设配置
- 文件：services/geminiservice.go
- 行号：234-247
- 问题：当 provider.EnvConfig 为 nil 时，创建空 map，导致预设配置丢失
- 修复：先复制预设配置，再补充 provider 字段
- 工作量：5 分钟

========================================
P2 优先级（设计问题）
========================================

【问题6】代理地址格式歧义
- 文件：services/geminiservice.go (行708-725) 和 main.go (行88)
- 问题：
  * ":18100" 在 Go 中表示监听所有网卡 (0.0.0.0:18100)
  * 当前代码假设它是端口，会补全为 "127.0.0.1:18100"
  * main.go:88 传入的是 ":18100"
- 影响：可能导致代理实际监听 0.0.0.0，引发安全隐患
- 修复：在 main.go:88 明确使用 "127.0.0.1:18100"
- 工作量：5 分钟

========================================
P3 优先级（改进）
========================================

【问题7】.env 文件行尾处理
- 文件：services/geminiservice.go
- 行号：391
- 问题：strings.Split(content, "\n") 在 Windows 下可能保留 \r
- 修复：strings.Split(strings.ReplaceAll(content, "\r\n", "\n"), "\n")
- 工作量：3 分钟
- 优先级：低（TrimSpace() 会补偿）

【问题8】测试覆盖不完整
- 缺失的测试：
  * buildProxyURL() 各种输入格式
  * SwitchProvider() 的切换逻辑和验证
  * EnableProxy()/DisableProxy() 的备份恢复
- 工作量：30 分钟

【问题9】缺少自定义目录支持
- 对标：cc-switch 有 get_gemini_override_dir()
- 影响：低（大多数用户不需要）
- 工作量：20 分钟

========================================
关键参考代码位置
========================================

参考项目中的最佳实践：

1. 两级验证机制
   - cc-switch/src-tauri/src/gemini_config.rs:226-278
   - validate_gemini_settings() - 基础格式检查
   - validate_gemini_settings_strict() - 必需字段检查

2. 安全的文件写入
   - cc-switch/src-tauri/src/gemini_config.rs:157-192
   - 原子操作 + 权限设置 (0600/0700)

3. 深度合并
   - cc-r 的实现已经很好，见 geminiservice.go:510-533

4. 单元测试
   - cc-switch/src-tauri/src/gemini_config.rs:375-656
   - 包含严格解析、验证、OAuth、API Key 等多个场景

========================================
建议的修复顺序
========================================

第1轮（5分钟）：
1. 修复测试参数缺失 → go test 能运行

第2轮（30分钟）：
2. 添加配置验证逻辑
3. 修复备份文件命名
4. 按认证类型区分 selectedType
5. 改进 envConfig 处理
6. 明确代理地址（main.go:88）

第3轮（30分钟）：
7. 改进 .env 行尾处理
8. 添加单元测试覆盖

========================================
验证方式
========================================

修复后请运行：

1. 单元测试
   go test ./services -v -run TestGemini

2. 功能测试
   - 启用代理后检查备份文件是否存在
   - 切换到无 API Key 的供应商是否返回错误
   - PackyCode 的 selectedType 是否为 "packycode"
   - buildProxyURL() 返回 "http://127.0.0.1:18100/gemini"

3. 集成测试
   - 前端能否成功切换 Gemini 供应商
   - 禁用后是否正确恢复备份

========================================
附注：关键代码位置映射
========================================

当前项目文件：

├── main.go (行88: NewGeminiService(":18100"))
└── services/
    ├── geminiservice.go
    │   ├── NewGeminiService() 行72-83
    │   ├── detectGeminiAuthType() 行316-348
    │   ├── SwitchProvider() 行195-271 ← 需要验证逻辑
    │   ├── buildProxyURL() 行708-725 ← 地址处理
    │   ├── EnableProxy() 行648-684 ← 备份文件名
    │   ├── DisableProxy() 行686-706 ← 备份文件名
    │   ├── parseEnvFile() 行388-412 ← 行尾处理
    │   └── writeGeminiSettings() 行479-508 ← 深度合并
    └── geminiservice_test.go
        ├── TestGeminiService_GetPresets() 行8 ← 缺参数
        └── TestGeminiPreset_Fields() 行233 ← 缺参数

参考项目文件：

└── src-tauri/src/
    ├── gemini_config.rs
    │   ├── get_gemini_dir() 行8-17 ← 自定义目录支持
    │   ├── parse_env_file() 行28-52 ← 宽松解析
    │   ├── parse_env_file_strict() 行76-125 ← 严格解析
    │   ├── validate_gemini_settings() 行226-251 ← 基础验证
    │   ├── validate_gemini_settings_strict() 行257-278 ← 严格验证
    │   ├── update_selected_type() 行296-337 ← 写入逻辑
    │   └── tests 行375-656 ← 完整测试覆盖
    └── gemini_mcp.rs ← MCP 相关（cc-r 由 MCPService 统一管理）

