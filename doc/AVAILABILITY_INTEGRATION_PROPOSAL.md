# å¯ç”¨æ€§ç›‘æ§å†…éƒ¨é›†æˆæ–¹æ¡ˆï¼ˆæœ€ç»ˆç‰ˆï¼‰

> å°† check-cx çš„æ ¸å¿ƒåŠŸèƒ½ç›´æ¥é›†æˆåˆ° Code-Switch ä¸­
> ä¸ Codex æ·±å…¥è®¨è®ºåçš„æœ€ç»ˆè®¾è®¡ï¼ˆv3.0ï¼‰

## 1. åŠŸèƒ½æ¦‚è¿°

### 1.1 æ ¸å¿ƒåŠŸèƒ½
1. **å¯ç”¨æ€§é¡µé¢**ï¼šé…ç½®å’Œå±•ç¤ºä¾›åº”å•†å¥åº·ç›‘æ§
2. **Provider ç¼–è¾‘é¡µé¢**ï¼šç®€åŒ–çš„"è¿é€šæ€§è‡ªåŠ¨æ‹‰é»‘"å¼€å…³
3. **è”åŠ¨é€»è¾‘**ï¼šå¼€å…³æ‰“å¼€ â†’ ä¸å¯ç”¨æ—¶è‡ªåŠ¨æ‹‰é»‘ï¼›å…³é—­ â†’ åªæ˜¾ç¤ºçŠ¶æ€

### 1.2 ç”¨æˆ·æ“ä½œæµç¨‹
```
1. è¿›å…¥"å¯ç”¨æ€§"é¡µé¢
2. çœ‹åˆ°æ‰€æœ‰ Provider åˆ—è¡¨ï¼Œå¯ç”¨éœ€è¦ç›‘æ§çš„ä¾›åº”å•†
3. ç³»ç»Ÿè‡ªåŠ¨ä½¿ç”¨é»˜è®¤å‚æ•°å¼€å§‹ç›‘æ§
4. ï¼ˆå¯é€‰ï¼‰ç‚¹å‡»"é«˜çº§é…ç½®"è‡ªå®šä¹‰å‚æ•°
5. è¿”å› Provider ç¼–è¾‘é¡µé¢ï¼Œæ‰“å¼€"è¿é€šæ€§è‡ªåŠ¨æ‹‰é»‘"å¼€å…³
6. å½“ç›‘æ§æ£€æµ‹åˆ°ä¸å¯ç”¨æ—¶ï¼Œè‡ªåŠ¨è§¦å‘æ‹‰é»‘
```

---

## 2. æ•°æ®ç»“æ„è®¾è®¡

### 2.1 Provider å­—æ®µå˜æ›´

**åˆ é™¤çš„å­—æ®µ**ï¼ˆä» Provider ç¼–è¾‘é¡µé¢ç§»é™¤ï¼‰ï¼š
```go
// åˆ é™¤ä»¥ä¸‹å­—æ®µ
ConnectivityTestModel    string  // ç§»è‡³å¯ç”¨æ€§é«˜çº§é…ç½®
ConnectivityTestEndpoint string  // ç§»è‡³å¯ç”¨æ€§é«˜çº§é…ç½®
ConnectivityAuthType     string  // ç§»è‡³å¯ç”¨æ€§é«˜çº§é…ç½®
```

**ä¿ç•™/æ–°å¢çš„å­—æ®µ**ï¼š
```go
type Provider struct {
    // ... ç°æœ‰å­—æ®µ ...

    // å¯ç”¨æ€§ç›‘æ§å¼€å…³ï¼ˆåœ¨å¯ç”¨æ€§é¡µé¢é…ç½®ï¼‰
    AvailabilityMonitorEnabled bool `json:"availabilityMonitorEnabled,omitempty"`

    // è¿é€šæ€§è‡ªåŠ¨æ‹‰é»‘å¼€å…³ï¼ˆåœ¨ Provider ç¼–è¾‘é¡µé¢é…ç½®ï¼‰
    // å‰ç½®æ¡ä»¶ï¼šAvailabilityMonitorEnabled å¿…é¡»ä¸º true
    ConnectivityAutoBlacklist bool `json:"connectivityAutoBlacklist,omitempty"`

    // å¯ç”¨æ€§é«˜çº§é…ç½®ï¼ˆå¯é€‰ï¼Œåœ¨å¯ç”¨æ€§é¡µé¢çš„"é«˜çº§é…ç½®"ä¸­è®¾ç½®ï¼‰
    AvailabilityConfig *AvailabilityConfig `json:"availabilityConfig,omitempty"`
}

type AvailabilityConfig struct {
    TestModel    string `json:"testModel,omitempty"`    // è¦†ç›–é»˜è®¤æµ‹è¯•æ¨¡å‹
    TestEndpoint string `json:"testEndpoint,omitempty"` // è¦†ç›–é»˜è®¤æµ‹è¯•ç«¯ç‚¹
    Timeout      int    `json:"timeout,omitempty"`      // è¦†ç›–é»˜è®¤è¶…æ—¶ï¼ˆæ¯«ç§’ï¼‰
}
```

### 2.2 é…ç½®æ–‡ä»¶ç¤ºä¾‹

```json
// ~/.code-switch/claude-code.json
{
  "providers": [
    {
      "id": 1,
      "name": "OpenAI Official",
      "apiUrl": "https://api.openai.com",
      "apiKey": "sk-xxx",
      "enabled": true,

      "availabilityMonitorEnabled": true,
      "connectivityAutoBlacklist": false,
      "availabilityConfig": {
        "testModel": "claude-3-5-haiku-20241022",
        "timeout": 15000
      }
    },
    {
      "id": 2,
      "name": "Backup Provider",
      "apiUrl": "https://api.backup.com",
      "apiKey": "sk-yyy",
      "enabled": true,

      "availabilityMonitorEnabled": true,
      "connectivityAutoBlacklist": true
    }
  ]
}
```

---

## 3. å…¨å±€è®¾ç½®

### 3.1 å¯ç”¨æ€§ç›‘æ§å…¨å±€é…ç½®

åœ¨å¯ç”¨æ€§é¡µé¢æä¾›å…¨å±€è®¾ç½®å…¥å£ï¼ˆå³ä¸Šè§’ âš™ï¸ æŒ‰é’®ï¼‰ï¼Œå­˜å‚¨åœ¨ `~/.code-switch/settings.json`ï¼š

```go
type AvailabilityGlobalConfig struct {
    // è‡ªåŠ¨æ‹‰é»‘å¤±è´¥é˜ˆå€¼ï¼ˆè¿ç»­æ£€æµ‹å¤±è´¥ N æ¬¡åè§¦å‘æ‹‰é»‘ï¼‰
    FailureThreshold int `json:"failureThreshold"` // é»˜è®¤ 2

    // æ£€æµ‹é—´éš”ï¼ˆç§’ï¼‰
    PollIntervalSeconds int `json:"pollIntervalSeconds"` // é»˜è®¤ 60

    // çŠ¶æ€åˆ¤å®šé˜ˆå€¼ï¼ˆæ¯«ç§’ï¼‰
    OperationalThresholdMs int `json:"operationalThresholdMs"` // é»˜è®¤ 6000
}
```

### 3.2 å…¨å±€è®¾ç½® UI

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸ å¯ç”¨æ€§ç›‘æ§è®¾ç½®                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  è‡ªåŠ¨æ‹‰é»‘é˜ˆå€¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 2                             æ¬¡  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â„¹ï¸ è¿ç»­æ£€æµ‹å¤±è´¥ N æ¬¡åè§¦å‘æ‹‰é»‘           â”‚
â”‚                                         â”‚
â”‚  æ£€æµ‹é—´éš”                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 60                            ç§’  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â„¹ï¸ åå°è‡ªåŠ¨æ£€æµ‹çš„æ—¶é—´é—´éš”                â”‚
â”‚                                         â”‚
â”‚  æ­£å¸¸çŠ¶æ€é˜ˆå€¼                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 6000                          ms  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â„¹ï¸ å“åº”å»¶è¿Ÿ â‰¤ æ­¤å€¼åˆ¤å®šä¸º"æ­£å¸¸"           â”‚
â”‚                                         â”‚
â”‚           [å–æ¶ˆ]          [ä¿å­˜]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 4. é»˜è®¤æ¨æ–­è§„åˆ™

å½“ç”¨æˆ·å¯ç”¨ç›‘æ§ä½†ä¸é…ç½®é«˜çº§å‚æ•°æ—¶ï¼Œä½¿ç”¨ä»¥ä¸‹é»˜è®¤å€¼ï¼š

| å‚æ•° | å¹³å° | é»˜è®¤å€¼ |
|------|------|--------|
| **æµ‹è¯•ç«¯ç‚¹** | Claude | `/v1/messages` |
| | Codex | `/responses` |
| | Gemini | `/v1beta/models/{model}:streamGenerateContent` |
| **æµ‹è¯•æ¨¡å‹** | Claude | `claude-3-5-haiku-20241022` |
| | Codex | `gpt-4o-mini` |
| | Gemini | `gemini-1.5-flash` |
| **è®¤è¯æ–¹å¼** | æ‰€æœ‰ | Bearerï¼ˆå¤ç”¨ Provider çš„ APIKeyï¼‰ |
| **è¶…æ—¶æ—¶é—´** | æ‰€æœ‰ | 15000msï¼ˆ15ç§’ï¼‰ |
| **çŠ¶æ€é˜ˆå€¼** | æ‰€æœ‰ | â‰¤6000ms=operational, >6000ms=degraded |
| **æ‹‰é»‘é˜ˆå€¼** | æ‰€æœ‰ | è¿ç»­ 2 æ¬¡å¤±è´¥ï¼ˆå¯é…ç½®ï¼‰ |

---

## 5. é¡µé¢è®¾è®¡

### 5.1 å¯ç”¨æ€§é¡µé¢ï¼ˆæ–°å¢ï¼‰

**ä½ç½®**ï¼šå·¦ä¾§æ æ–°å¢"å¯ç”¨æ€§"èœå•é¡¹

**å¸ƒå±€**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸ” å¯ç”¨æ€§ç›‘æ§                                    [å…¨éƒ¨æ£€æµ‹] [âš™ï¸] â”‚
â”‚  å®æ—¶ç›‘æ§ AI ä¾›åº”å•†çš„å¥åº·çŠ¶æ€                                    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  ğŸ“Š çŠ¶æ€æ¦‚è§ˆ                                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”              â”‚
â”‚  â”‚ ğŸŸ¢ 3    â”‚ â”‚ ğŸŸ¡ 1    â”‚ â”‚ ğŸ”´ 0    â”‚ â”‚ âš« 2    â”‚              â”‚
â”‚  â”‚ æ­£å¸¸    â”‚ â”‚ å»¶è¿Ÿ    â”‚ â”‚ æ•…éšœ    â”‚ â”‚ æœªå¯ç”¨   â”‚              â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜              â”‚
â”‚                                                                 â”‚
â”‚  æœ€åæ›´æ–°: 14:30:25  |  ä¸‹æ¬¡æ£€æµ‹: 45s                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                 â”‚
â”‚  Claude ä¾›åº”å•†                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [å¼€å…³] Provider A          ğŸŸ¢ æ­£å¸¸  1234ms  [æ£€æµ‹] [âš™ï¸]     â”‚â”‚
â”‚  â”‚        â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡ å¯ç”¨ç‡: 98.3%                   â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ [å¼€å…³] Provider B          ğŸŸ¡ å»¶è¿Ÿ  7891ms  [æ£€æµ‹] [âš™ï¸]     â”‚â”‚
â”‚  â”‚        â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡ å¯ç”¨ç‡: 85.0%                   â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ [    ] Provider C          âš« æœªå¯ç”¨                        â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â”‚  Codex ä¾›åº”å•†                                                   â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ [å¼€å…³] Provider D          ğŸŸ¢ æ­£å¸¸  2345ms  [æ£€æµ‹] [âš™ï¸]     â”‚â”‚
â”‚  â”‚        â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡â–‡ å¯ç”¨ç‡: 99.1%                   â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**äº¤äº’è¯´æ˜**ï¼š
- **å¼€å…³**ï¼šå¯ç”¨/ç¦ç”¨è¯¥ Provider çš„ç›‘æ§
- **[æ£€æµ‹]**ï¼šæ‰‹åŠ¨è§¦å‘å•ä¸ª Provider æ£€æµ‹
- **[âš™ï¸]**ï¼šæ‰“å¼€é«˜çº§é…ç½®å¼¹çª—
- **æ—¶é—´çº¿æ¡**ï¼šé¼ æ ‡æ‚¬åœæ˜¾ç¤ºå†å²æ£€æµ‹è¯¦æƒ…

### 5.2 é«˜çº§é…ç½®å¼¹çª—

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  âš™ï¸ é«˜çº§é…ç½® - Provider A               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  æµ‹è¯•æ¨¡å‹                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ claude-3-5-haiku-20241022     [â–¼] â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â„¹ï¸ é»˜è®¤ä½¿ç”¨ä½æˆæœ¬æ¨¡å‹                   â”‚
â”‚                                         â”‚
â”‚  æµ‹è¯•ç«¯ç‚¹                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ /v1/messages                      â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â„¹ï¸ ç•™ç©ºä½¿ç”¨é»˜è®¤ç«¯ç‚¹                     â”‚
â”‚                                         â”‚
â”‚  è¶…æ—¶æ—¶é—´                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚ 15000                         ms  â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â„¹ï¸ é»˜è®¤ 15 ç§’                          â”‚
â”‚                                         â”‚
â”‚           [å–æ¶ˆ]          [ä¿å­˜]        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 5.3 Provider ç¼–è¾‘é¡µé¢ï¼ˆç®€åŒ–ï¼‰

**è¿é€šæ€§åŒºå—å˜æ›´**ï¼š

**Beforeï¼ˆç°æœ‰ï¼‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿é€šæ€§æ£€æµ‹                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ [âœ“] å¯ç”¨è¿é€šæ€§æ£€æµ‹                       â”‚
â”‚                                         â”‚
â”‚ æµ‹è¯•æ¨¡å‹                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ claude-3-5-haiku-20241022         â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚ æµ‹è¯•ç«¯ç‚¹                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ /v1/messages                      â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚                                         â”‚
â”‚ è®¤è¯æ–¹å¼                                â”‚
â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚ â”‚ Bearer                        [â–¼] â”‚   â”‚
â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**Afterï¼ˆç®€åŒ–åï¼‰**ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿é€šæ€§è‡ªåŠ¨æ‹‰é»‘                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ [âœ“] ä¸å¯ç”¨æ—¶è‡ªåŠ¨æ‹‰é»‘                     â”‚  â† å¼€å…³
â”‚                                         â”‚
â”‚ â„¹ï¸ å½“å¯ç”¨æ€§ç›‘æ§æ£€æµ‹åˆ°æ•…éšœæ—¶ï¼Œè‡ªåŠ¨è§¦å‘æ‹‰é»‘   â”‚
â”‚                                         â”‚
â”‚ å½“å‰ç›‘æ§çŠ¶æ€: ğŸŸ¢ æ­£å¸¸ (1234ms)           â”‚  â† åªè¯»å±•ç¤º
â”‚ æœ€è¿‘æ£€æµ‹: 14:30:25                      â”‚
â”‚                                         â”‚
â”‚ ğŸ’¡ å‰å¾€ [å¯ç”¨æ€§] é¡µé¢é…ç½®ç›‘æ§å‚æ•°         â”‚  â† è·³è½¬é“¾æ¥
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**å¼€å…³ç¦ç”¨çŠ¶æ€**ï¼ˆæœªåœ¨å¯ç”¨æ€§é¡µé¢å¯ç”¨ç›‘æ§æ—¶ï¼‰ï¼š
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿é€šæ€§è‡ªåŠ¨æ‹‰é»‘                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚ [ ] ä¸å¯ç”¨æ—¶è‡ªåŠ¨æ‹‰é»‘                     â”‚  â† ç°è‰²ç¦ç”¨
â”‚                                         â”‚
â”‚ âš ï¸ è¯·å…ˆåœ¨ [å¯ç”¨æ€§] é¡µé¢å¯ç”¨ç›‘æ§           â”‚  â† æç¤º
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## 6. åç«¯è®¾è®¡

### 6.1 æœåŠ¡èŒè´£

| æœåŠ¡ | èŒè´£ |
|------|------|
| `HealthCheckService` | æ‰§è¡Œå¥åº·æ£€æŸ¥ã€å­˜å‚¨ç»“æœã€å®šæ—¶å·¡æ£€ |
| `ProviderService` | åŠ è½½/ä¿å­˜ Provider é…ç½®ï¼ˆå«æ–°å­—æ®µï¼‰ |
| `BlacklistService` | æ‰§è¡Œæ‹‰é»‘/è§£é™¤æ‹‰é»‘ï¼ˆç°æœ‰ï¼‰ |

### 6.2 HealthCheckService æ ¸å¿ƒæ–¹æ³•

```go
// è·å–æ‰€æœ‰ Provider çš„æœ€æ–°çŠ¶æ€ï¼ˆæŒ‰å¹³å°åˆ†ç»„ï¼‰
func (hcs *HealthCheckService) GetLatestResults() (map[string][]HealthCheckResult, error)

// è·å–å•ä¸ª Provider çš„å†å²è®°å½•
func (hcs *HealthCheckService) GetHistory(platform, providerName string, limit int) (*HealthCheckHistory, error)

// æ‰‹åŠ¨è§¦å‘å•ä¸ª Provider æ£€æµ‹
func (hcs *HealthCheckService) RunSingleCheck(platform string, providerId int64) (*HealthCheckResult, error)

// æ‰‹åŠ¨è§¦å‘å…¨éƒ¨æ£€æµ‹
func (hcs *HealthCheckService) RunAllChecks() (map[string][]HealthCheckResult, error)

// å¯åŠ¨åå°å®šæ—¶å·¡æ£€ï¼ˆåº”ç”¨å¯åŠ¨æ—¶è°ƒç”¨ï¼‰
func (hcs *HealthCheckService) StartBackgroundPolling(interval time.Duration)

// åœæ­¢åå°å·¡æ£€
func (hcs *HealthCheckService) StopBackgroundPolling()
```

### 6.3 æ£€æµ‹ä¸æ‹‰é»‘è”åŠ¨é€»è¾‘ï¼ˆç‹¬ç«‹è®¡æ•°å™¨ï¼‰

**æ ¸å¿ƒæœºåˆ¶**ï¼šå¯ç”¨æ€§ç›‘æ§ä½¿ç”¨**ç‹¬ç«‹çš„å¤±è´¥è®¡æ•°å™¨**ï¼Œä¸çœŸå®è¯·æ±‚çš„å¤±è´¥è®¡æ•°åˆ†å¼€ã€‚

```go
// æ¯ä¸ª Provider ç»´æŠ¤ç‹¬ç«‹çš„å¯ç”¨æ€§å¤±è´¥è®¡æ•°
type AvailabilityFailureCounter struct {
    Platform         string
    ProviderName     string
    ConsecutiveFails int       // è¿ç»­å¤±è´¥æ¬¡æ•°
    LastFailedAt     time.Time // æœ€åå¤±è´¥æ—¶é—´
}

func (hcs *HealthCheckService) handleCheckResult(result *HealthCheckResult, provider *Provider) {
    // 1. å­˜å‚¨æ£€æµ‹ç»“æœ
    hcs.saveResult(result)

    // 2. æ›´æ–°å†…å­˜ç¼“å­˜
    hcs.updateCache(result)

    // 3. æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘æ‹‰é»‘
    if !provider.ConnectivityAutoBlacklist {
        return // æœªå¯ç”¨è‡ªåŠ¨æ‹‰é»‘ï¼Œç›´æ¥è¿”å›
    }

    // 4. è·å–å…¨å±€é…ç½®çš„å¤±è´¥é˜ˆå€¼
    globalConfig := hcs.settingsService.GetAvailabilityGlobalConfig()
    threshold := globalConfig.FailureThreshold // é»˜è®¤ 2

    // 5. æ›´æ–°ç‹¬ç«‹çš„å¤±è´¥è®¡æ•°å™¨
    counter := hcs.getOrCreateCounter(result.Platform, provider.Name)

    if result.Status == "failed" {
        counter.ConsecutiveFails++
        counter.LastFailedAt = time.Now()

        log.Printf("âš ï¸ Provider %s æ£€æµ‹å¤±è´¥ï¼Œè¿ç»­å¤±è´¥: %d/%d",
            provider.Name, counter.ConsecutiveFails, threshold)

        // è¾¾åˆ°é˜ˆå€¼ï¼Œè§¦å‘æ‹‰é»‘
        if counter.ConsecutiveFails >= threshold {
            hcs.blacklistService.RecordFailure(result.Platform, provider.Name)
            log.Printf("ğŸ”´ Provider %s è¿ç»­å¤±è´¥ %d æ¬¡ï¼Œè§¦å‘æ‹‰é»‘ï¼", provider.Name, threshold)
        }
    } else if result.Status == "operational" {
        // æˆåŠŸï¼Œæ¸…é›¶å¤±è´¥è®¡æ•°
        if counter.ConsecutiveFails > 0 {
            log.Printf("âœ… Provider %s æ¢å¤æ­£å¸¸ï¼Œæ¸…é›¶å¤±è´¥è®¡æ•°ï¼ˆä¹‹å‰: %dï¼‰",
                provider.Name, counter.ConsecutiveFails)
        }
        counter.ConsecutiveFails = 0
        hcs.blacklistService.RecordSuccess(result.Platform, provider.Name)
    }
    // degraded çŠ¶æ€ä¸è§¦å‘æ‹‰é»‘ï¼Œä¹Ÿä¸æ¸…é›¶è®¡æ•°
}
```

### 6.4 æ•°æ®åº“è¡¨

```sql
CREATE TABLE IF NOT EXISTS health_check_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    provider_id INTEGER NOT NULL,
    provider_name TEXT NOT NULL,
    platform TEXT NOT NULL,
    model TEXT,
    endpoint TEXT,
    status TEXT NOT NULL,          -- operational/degraded/failed
    latency_ms INTEGER,
    error_message TEXT,
    checked_at DATETIME DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_health_provider ON health_check_history(platform, provider_name);
CREATE INDEX IF NOT EXISTS idx_health_checked_at ON health_check_history(checked_at);
```

---

## 7. å®ç°ä»»åŠ¡æ¸…å•

### 7.1 åç«¯

- [ ] ä¿®æ”¹ `Provider` ç»“æ„ï¼Œåˆ é™¤æ—§å­—æ®µã€æ–°å¢æ–°å­—æ®µ
- [ ] æ–°å»º `services/healthcheckservice.go`
- [ ] å®ç°å¥åº·æ£€æŸ¥æ ¸å¿ƒé€»è¾‘ï¼ˆæµå¼é¦–å—åˆ¤å®šï¼‰
- [ ] å®ç°ä¸åŒå¹³å°çš„è¯·æ±‚æ„é€ é€‚é…å™¨
- [ ] æ•°æ®åº“è¿ç§»ï¼šåˆ›å»º `health_check_history` è¡¨
- [ ] å®ç°åå°å®šæ—¶å·¡æ£€
- [ ] å®ç°ä¸ BlacklistService çš„è”åŠ¨
- [ ] æ³¨å†Œåˆ° Wails åº”ç”¨

### 7.2 å‰ç«¯

- [ ] æ–°å»º `components/Availability/` ç›®å½•
- [ ] å®ç° `Index.vue` å¯ç”¨æ€§é¡µé¢
- [ ] å®ç° `ProviderMonitorCard.vue` ç›‘æ§å¡ç‰‡
- [ ] å®ç° `StatusTimeline.vue` çŠ¶æ€æ—¶é—´çº¿
- [ ] å®ç° `AdvancedConfigModal.vue` é«˜çº§é…ç½®å¼¹çª—
- [ ] ä¿®æ”¹ Provider ç¼–è¾‘é¡µé¢ï¼Œç®€åŒ–è¿é€šæ€§åŒºå—
- [ ] æ·»åŠ è·¯ç”±é…ç½®
- [ ] æ›´æ–° Sidebar.vue æ·»åŠ èœå•é¡¹
- [ ] æ·»åŠ å›½é™…åŒ–æ–‡æœ¬

### 7.3 æ•°æ®è¿ç§»

- [ ] è¿ç§»è„šæœ¬ï¼šå°†æ—§çš„ `ConnectivityCheck` å­—æ®µå€¼è¿ç§»åˆ° `AvailabilityMonitorEnabled`
- [ ] æ¸…ç†è„šæœ¬ï¼šåˆ é™¤ Provider é…ç½®ä¸­çš„æ—§å­—æ®µ

---

## 8. è®¨è®ºè®°å½•æ‘˜è¦

### å…³é”®å†³ç­–

| é—®é¢˜ | å†³ç­– |
|------|------|
| é…ç½®å­˜å‚¨æ–¹å¼ | å¤ç”¨ Provider é…ç½®æ–‡ä»¶ï¼ˆæ–¹æ¡ˆBï¼‰ |
| Provider ä¸ç›‘æ§é…ç½®å…³ç³» | 1:1ï¼ˆä¸€ä¸ª Provider ä¸€ä¸ªç›‘æ§é…ç½®ï¼‰ |
| å‚æ•°é…ç½®ä½ç½® | å¯ç”¨æ€§é¡µé¢çš„"é«˜çº§é…ç½®"å¼¹çª— |
| Provider ç¼–è¾‘é¡µé¢ | åªä¿ç•™ä¸€ä¸ª"è¿é€šæ€§è‡ªåŠ¨æ‹‰é»‘"å¼€å…³ |
| å¼€å…³å‰ç½®æ¡ä»¶ | å¿…é¡»å…ˆåœ¨å¯ç”¨æ€§é¡µé¢å¯ç”¨ç›‘æ§ |
| é»˜è®¤è¡Œä¸º | å¯ç”¨ç›‘æ§ä½†ä¸è‡ªåŠ¨æ‹‰é»‘ï¼ˆå®‰å…¨ï¼‰ |
| **æ‹‰é»‘é˜ˆå€¼** | **å¯é…ç½®ï¼Œé»˜è®¤è¿ç»­ 2 æ¬¡å¤±è´¥ï¼Œç‹¬ç«‹è®¡æ•°å™¨** |
| **é˜ˆå€¼é…ç½®ä½ç½®** | **å¯ç”¨æ€§é¡µé¢çš„å…¨å±€è®¾ç½®** |

### å­—æ®µå˜æ›´

| æ“ä½œ | å­—æ®µ |
|------|------|
| **åˆ é™¤** | `ConnectivityCheck`ï¼ˆæ”¹åï¼‰ |
| **åˆ é™¤** | `ConnectivityTestModel`ï¼ˆç§»è‡³é«˜çº§é…ç½®ï¼‰ |
| **åˆ é™¤** | `ConnectivityTestEndpoint`ï¼ˆç§»è‡³é«˜çº§é…ç½®ï¼‰ |
| **åˆ é™¤** | `ConnectivityAuthType`ï¼ˆç§»è‡³é«˜çº§é…ç½®ï¼‰ |
| **æ–°å¢** | `AvailabilityMonitorEnabled`ï¼ˆå¯ç”¨æ€§é¡µé¢å¼€å…³ï¼‰ |
| **æ–°å¢** | `ConnectivityAutoBlacklist`ï¼ˆProvider é¡µé¢å¼€å…³ï¼‰ |
| **æ–°å¢** | `AvailabilityConfig`ï¼ˆé«˜çº§é…ç½®å¯¹è±¡ï¼‰ |

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šv3.1ï¼ˆå¢åŠ å¯é…ç½®æ‹‰é»‘é˜ˆå€¼ï¼‰
**æ›´æ–°æ—¶é—´**ï¼š2025-12-10
**è®¨è®ºå‚ä¸**ï¼šClaude Opus 4.5 + Codex (OpenAI o4-mini)
