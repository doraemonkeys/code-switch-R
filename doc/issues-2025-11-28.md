# å½“å‰é¡¹ç›®å·²çŸ¥é—®é¢˜æ¸…å•ï¼ˆ2025-11-28ï¼‰

> ç›®çš„ï¼šé›†ä¸­è®°å½•ç›®å‰å·²å‘ç°çš„é˜»æ–­/é«˜é£é™©é—®é¢˜ï¼Œä¾¿äºåç»­æ’æŸ¥ä¸ä¿®å¤ã€‚

## é˜»æ–­çº§ï¼ˆåº”ç”¨æ— æ³•æ­£å¸¸å¯åŠ¨ï¼‰

### ğŸš« æ•°æ®åº“åˆå§‹åŒ–æ—¶åºé”™è¯¯ â€”â€” å¯åŠ¨å³å´©æºƒ
- **ä½ç½®**ï¼š`main.go:72-74` å’Œ `services/dbqueue.go:26-30`
- **ç°çŠ¶**ï¼š
  - `InitGlobalDBQueue()` åœ¨ç¬¬ 72 è¡Œè°ƒç”¨ `xdb.DB("default")`
  - ä½† `xdb.Inits()` åœ¨ `NewProviderRelayService()` å†…éƒ¨ï¼ˆ`providerrelay.go:39-66`ï¼‰æ‰æ‰§è¡Œ
  - `NewProviderRelayService()` åœ¨ç¬¬ 81 è¡Œæ‰æ„é€ ï¼Œæ™šäº `InitGlobalDBQueue()`
  - ç»“æœï¼š`xdb.DB("default")` è¿”å›é”™è¯¯ï¼Œ`log.Fatalf` ç»ˆæ­¢è¿›ç¨‹
- **åŒæ ·å—å½±å“**ï¼š
  - `NewSettingsService()` æ„é€ å™¨è°ƒç”¨ `ensureBlacklistTables()`ï¼ˆ`settingsservice.go:67-71`ï¼‰ï¼Œä¹Ÿä¾èµ– `xdb.DB("default")`
  - åœ¨ç¬¬ 78 è¡Œè°ƒç”¨ï¼ŒåŒæ ·æ—©äºæ•°æ®åº“åˆå§‹åŒ–
- **ä¿®å¤æ–¹å‘**ï¼šå°† `xdb.Inits()` ç§»åˆ° `main()` å…¥å£æœ€å‰é¢ï¼Œåœ¨ä»»ä½•æœåŠ¡æ„é€ ä¹‹å‰å®Œæˆ

### ğŸ’¥ SQLite çˆ¶ç›®å½•æœªåˆ›å»º â€”â€” é¦–æ¬¡å¯åŠ¨å´©æºƒ
- **ä½ç½®**ï¼š`services/providerrelay.go:37-43`
- **ç°çŠ¶**ï¼š
  ```go
  home, _ := os.UserHomeDir()

  if err := xdb.Inits([]xdb.Config{
      {
          DSN: filepath.Join(home, ".code-switch", "app.db?..."),
      },
  }); err != nil {
  ```
  - SQLite ä¸ä¼šè‡ªåŠ¨åˆ›å»ºçˆ¶ç›®å½• `~/.code-switch/`
  - é¦–æ¬¡å¯åŠ¨æ—¶å¦‚æœç›®å½•ä¸å­˜åœ¨ï¼Œ`xdb.Inits()` ä¼šå› çˆ¶ç›®å½•ç¼ºå¤±è€Œå¤±è´¥
  - è§¦å‘é˜»æ–­çº§é—®é¢˜ 1 çš„å¯åŠ¨å´©æºƒ
- **ä¿®å¤æ–¹å‘**ï¼š
  ```go
  configDir := filepath.Join(home, ".code-switch")
  os.MkdirAll(configDir, 0755)  // â† åœ¨ xdb.Inits() ä¹‹å‰åˆ›å»º
  ```

### âš ï¸ SuiStore é”™è¯¯è¢«åæ‰ï¼Œç•™ä¸‹ç©ºæŒ‡é’ˆéšæ‚£
- **ä½ç½®**ï¼š`main.go:66-70`
- **ç°çŠ¶**ï¼š
  ```go
  suiService, errt := services.NewSuiStore()
  if errt != nil {
      // å¤„ç†é”™è¯¯ï¼Œæ¯”å¦‚æ—¥å¿—æˆ–é€€å‡º
  }  // â† é”™è¯¯è¢«å®Œå…¨å¿½ç•¥ï¼
  ```
  - `suiService` å¯èƒ½ä¸º nil æˆ–å†…éƒ¨çŠ¶æ€ä¸å®Œæ•´
  - ä»è¢«æ³¨å†Œåˆ° Wailsï¼š`application.NewService(suiService)`
  - å‰ç«¯è°ƒç”¨å…¶æ–¹æ³•æ—¶ä¼š panic
- **ä¿®å¤æ–¹å‘**ï¼šå¤±è´¥æ—¶ç›´æ¥ `log.Fatalf` é€€å‡ºï¼Œæˆ–ä¸æ³¨å†Œè¯¥æœåŠ¡

### `go test ./...` å…¨é¢å¤±è´¥
- `main.go` ä¸­ `//go:embed all:frontend/dist` æ‰¾ä¸åˆ°æ„å»ºäº§ç‰©ï¼ˆæœªç”Ÿæˆ `frontend/dist`ï¼‰ï¼Œå¯¼è‡´ä¸»åŒ…ç¼–è¯‘å¤±è´¥
- `scripts/` ä¸‹å¤šä¸ª `package main`ï¼Œé‡å¤å®šä¹‰ `main/Provider/Config`ï¼Œåœ¨æµ‹è¯•æ—¶ä¸€èµ·ç¼–è¯‘è§¦å‘ "redeclared" é”™è¯¯ã€‚åº”åŠ  `//go:build ignore` æˆ–è¿ç§»å‡ºæ¨¡å—
- `services/geminiservice_test.go` æ„é€ å‡½æ•°è°ƒç”¨ç¼ºå°‘å¿…é¡»çš„åœ°å€å‚æ•°ï¼ˆ`NewGeminiService(string)`ï¼‰ï¼Œå½“å‰ç­¾åä¸åŒ¹é…

## é«˜ä¼˜å…ˆçº§ï¼ˆå®‰å…¨æ¼æ´ï¼‰

### ğŸ”¥ ä»£ç†æœåŠ¡ç›‘å¬ 0.0.0.0 æ— é‰´æƒ â€”â€” API Key å…¨ç½‘æš´éœ²
- **ä½ç½®**ï¼š`services/providerrelay.go:32-35, 89-91`
- **ç°çŠ¶**ï¼š
  ```go
  // æ„é€ å‡½æ•°é»˜è®¤å€¼
  if addr == "" {
      addr = ":18100"  // â† ç›‘å¬ 0.0.0.0:18100
  }

  // Start() å¯åŠ¨æœåŠ¡å™¨
  prs.server = &http.Server{
      Addr:    prs.addr,  // â† ":18100" = æ‰€æœ‰ç½‘å¡
      Handler: router,
  }
  ```
- **å®‰å…¨é£é™©**ï¼šğŸ”´ **ç¾éš¾çº§**
  - åŒä¸€ç½‘æ®µä»»ä½•è®¾å¤‡éƒ½å¯è®¿é—® `http://<ä½ çš„IP>:18100/v1/messages`
  - ç›´æ¥å€Ÿç”¨æœ¬åœ°ä¿å­˜çš„ Provider API Key å‘èµ·è¯·æ±‚
  - **ç›¸å½“äºæŠŠä½ æ‰€æœ‰ Claude/Codex çš„ API å¯†é’¥å…¬å¼€åˆ°å±€åŸŸç½‘ï¼**
  - åœ¨å…¬å¸ç½‘ç»œã€å…¬å…± WiFi ä¸‹ä½¿ç”¨ = å¯†é’¥æ³„éœ²
- **ä¿®å¤æ–¹å‘**ï¼š
  1. æ”¹ä¸ºä»…ç›‘å¬ `127.0.0.1:18100`
  2. æˆ–æ·»åŠ  Bearer Token é‰´æƒï¼ˆä»æœ¬åœ°é…ç½®è¯»å–ï¼‰
  3. æˆ–æ·»åŠ è¯·æ±‚æ¥æºæ ¡éªŒï¼ˆåªå…è®¸ localhostï¼‰

### ğŸ” SSRF æ”»å‡»é¢ â€”â€” æ¡Œé¢ç«¯æš´éœ²ä¸¥é‡å®‰å…¨æ¼æ´
- **ä½ç½®**ï¼š`services/speedtestservice.go:45-120`
- **ç°çŠ¶**ï¼š
  ```go
  // éªŒè¯ URLï¼ˆä»…æ£€æŸ¥æ ¼å¼ï¼‰
  parsedURL, err := url.Parse(trimmed)
  if err != nil {
      return ...
  }

  // æ— ä»»ä½•è¿‡æ»¤ï¼Œç›´æ¥è¯·æ±‚ï¼
  _, _ = s.makeRequest(client, parsedURL.String())
  ```
  - **æ²¡æœ‰ä»»ä½•åè®®ã€IPã€ç«¯å£ç™½åå•é™åˆ¶**
  - ä»»ä½• URL éƒ½ä¼šè¢«åº”ç”¨ä¸»åŠ¨è¯·æ±‚
- **æ”»å‡»å‘é‡**ï¼š
  - âœ… `file:///etc/passwd` â†’ è¯»å–æœ¬åœ°æ–‡ä»¶
  - âœ… `http://127.0.0.1:22` â†’ å†…ç½‘ç«¯å£æ‰«æ
  - âœ… `http://192.168.1.1/admin` â†’ æ¢æµ‹å†…ç½‘è®¾å¤‡
  - âœ… `http://169.254.169.254/latest/meta-data/` â†’ äº‘æœåŠ¡å™¨å…ƒæ•°æ®æ³„éœ²ï¼ˆAWS IMDSï¼‰
  - âœ… `gopher://localhost:6379/...` â†’ å¯èƒ½çš„åè®®èµ°ç§ï¼ˆéœ€éªŒè¯ Go æ”¯æŒï¼‰
- **å®‰å…¨ç­‰çº§**ï¼šğŸ”´ **ä¸¥é‡**ï¼ˆæ¡Œé¢åº”ç”¨æš´éœ² SSRFï¼Œå¯è¢«é’“é±¼ç½‘ç«™åˆ©ç”¨ï¼‰
- **ä¿®å¤æ–¹å‘**ï¼š
  1. åè®®ç™½åå•ï¼šåªå…è®¸ `http://` å’Œ `https://`
  2. IP é»‘åå•ï¼šæ‹¦æˆªå†…ç½‘åœ°å€ï¼ˆ`127.0.0.0/8`, `10.0.0.0/8`, `172.16.0.0/12`, `192.168.0.0/16`, `169.254.0.0/16`ï¼‰
  3. ç«¯å£ç™½åå•ï¼šåªå…è®¸ 80/443
  4. åŸŸåç™½åå•ï¼ˆå¯é€‰ï¼‰ï¼šé™åˆ¶ä»…æµ‹é€Ÿå·²çŸ¥çš„ API ç«¯ç‚¹

### ğŸ›¡ï¸ è‡ªåŠ¨æ›´æ–°å­˜åœ¨å®‰å…¨ä¸ç”¨æˆ·ä½“éªŒé£é™©
- **ä½ç½®**ï¼š`services/updateservice.go`
- **ç°çŠ¶**ï¼š
  - `UpdateInfo.SHA256` å­—æ®µå­˜åœ¨ï¼ˆç¬¬ 29 è¡Œï¼‰ï¼Œ`calculateSHA256()` å‡½æ•°å­˜åœ¨ï¼ˆç¬¬ 815 è¡Œï¼‰
  - **ä½†ä¸‹è½½åä»æœªè°ƒç”¨æ ¡éªŒï¼** ç›´æ¥æ‰§è¡Œ/æ›¿æ¢
  - Windows åˆ†æ”¯ç›´æ¥é™é»˜æ‰§è¡Œä¸‹è½½å™¨
  - ä¾¿æºç‰ˆ/Linux ç›´æ¥æ›¿æ¢å½“å‰å¯æ‰§è¡Œå¹¶é‡å¯
  - ç¼ºä¹ç”¨æˆ·ç¡®è®¤ä¸å›æ»šè·¯å¾„
  - macOS åˆ†æ”¯ï¼ˆç¬¬ 494 è¡Œèµ·ï¼‰ä»æ˜¯ TODOï¼ŒåŠŸèƒ½ç¼ºå¤±ä½†å…¥å£å·²æš´éœ²
- **å®‰å…¨é£é™©**ï¼š
  - ä¸­é—´äººæ”»å‡»å¯ç¯¡æ”¹ä¸‹è½½å†…å®¹
  - æŸåçš„å®‰è£…åŒ…æ— æ³•å›æ»š
- **ä¿®å¤æ–¹å‘**ï¼š
  1. ä¸‹è½½åè°ƒç”¨ `calculateSHA256()` ä¸ `UpdateInfo.SHA256` æ¯”å¯¹
  2. æ ¡éªŒå¤±è´¥åˆ™åˆ é™¤æ–‡ä»¶ã€è®°å½•æ—¥å¿—ã€é€šçŸ¥ç”¨æˆ·
  3. æ·»åŠ ç”¨æˆ·ç¡®è®¤å¯¹è¯æ¡†
  4. å¤‡ä»½å½“å‰ç‰ˆæœ¬ç”¨äºå›æ»š

## é«˜ä¼˜å…ˆçº§ï¼ˆé€»è¾‘é”™è¯¯ï¼‰

### ğŸ”´ é…ç½®ç›®å½•æ‹¼å†™é”™è¯¯ â€”â€” è®¾ç½®æ°¸ä¸ç”Ÿæ•ˆ
- **ä½ç½®**ï¼š`services/appsettings.go:10-11`
- **ç°çŠ¶**ï¼š
  ```go
  const (
      appSettingsDir  = ".codex-swtich"  // â† æ‹¼å†™é”™è¯¯ï¼swtich != switch
      appSettingsFile = "app.json"
  )
  ```
- **å½±å“**ï¼š
  - ç”¨æˆ·è®¾ç½®ä¿å­˜åˆ° `~/.codex-swtich/app.json`ï¼ˆé”™è¯¯è·¯å¾„ï¼‰
  - å…¶ä»–æœåŠ¡æœŸæœ›ä» `~/.code-switch/` è¯»å–ï¼ˆæ­£ç¡®è·¯å¾„ï¼‰
  - **æ¯æ¬¡å¯åŠ¨éƒ½è¯»ä¸åˆ°é…ç½®ï¼Œå›é€€åˆ°é»˜è®¤å€¼**
  - è‡ªå¯åŠ¨ã€è‡ªåŠ¨æ›´æ–°ã€çƒ­åŠ›å›¾æ˜¾ç¤ºç­‰è®¾ç½®æ°¸è¿œä¸ç”Ÿæ•ˆ
  - ç”¨æˆ·å›°æƒ‘"ä¸ºä»€ä¹ˆæˆ‘çš„è®¾ç½®ä¸ä¿å­˜"
- **å®‰å…¨ç­‰çº§**ï¼šğŸŸ  **ä½çº§ä½†è‡´å‘½**ï¼ˆä¸€ä¸ªå­—æ¯æ‹¼é”™å¯¼è‡´åŠŸèƒ½å®Œå…¨å¤±æ•ˆï¼‰
- **ä¿®å¤æ–¹å‘**ï¼š
  ```go
  const (
      appSettingsDir  = ".code-switch"  // â† ä¿®æ­£æ‹¼å†™
      appSettingsFile = "app.json"
  )
  ```

### ğŸŸ¥ è¯·æ±‚è½¬å‘ç¼ºä¹æ•…éšœåˆ‡æ¢ â€”â€” å•ç‚¹å¤±è´¥ä¸è¯¯æ‹‰é»‘
- **ä½ç½®**ï¼š`services/providerrelay.go:262-323`
- **ç°çŠ¶**ï¼š
  ```go
  // åªå–ç¬¬ä¸€ä¸ª Level çš„ç¬¬ä¸€ä¸ª provider
  firstLevel := levels[0]
  firstProvider := levelGroups[firstLevel][0]

  // åªå°è¯•è¿™ä¸€ä¸ªï¼Œå¤±è´¥ç›´æ¥è¿”å› 502
  ok, err := prs.forwardRequest(...)
  if !ok {
      c.JSON(http.StatusBadGateway, ...)  // æ²¡æœ‰å°è¯•å…¶ä»– providerï¼
  }
  ```
- **å½±å“**ï¼š
  - ä¸ `CLAUDE.md` æ–‡æ¡£æè¿°çš„"Level å†…æŒ‰é¡ºåºå°è¯•ï¼Œå¤±è´¥åé™çº§åˆ°ä¸‹ä¸€ Level"ä¸¥é‡ä¸ç¬¦
  - å•ä¸ª provider æ•…éšœç›´æ¥å¯¼è‡´ 502ï¼Œå®Œå…¨ä¸å°è¯•åŒçº§æˆ–ä¸‹çº§å¤‡é€‰
  - è¯¯æ‹‰é»‘æ¦‚ç‡é«˜ï¼šç½‘ç»œæŠ–åŠ¨ä¹Ÿä¼šè§¦å‘ `RecordFailure`
- **ä¿®å¤æ–¹å‘**ï¼š
  1. éå† `levelGroups[level]` çš„æ‰€æœ‰ providerï¼Œå¤±è´¥åç»§ç»­å°è¯•
  2. å½“å‰ Level å…¨å¤±è´¥åï¼Œé™åˆ°ä¸‹ä¸€ Level
  3. æ¯æ¬¡å°è¯•å‰é‡ç½® `c.Request.Body`ï¼ˆä½¿ç”¨ç¼“å­˜çš„ `bodyBytes`ï¼‰
  4. è®¾ç½®æœ€å¤§å°è¯•æ¬¡æ•°æˆ–æ•´ä½“è¶…æ—¶

### ğŸŸ£ é 2xx å“åº”ä¸€å¾‹æ‹‰é»‘ â€”â€” å¥åº·èŠ‚ç‚¹è¢«è¯¯æ€
- **ä½ç½®**ï¼š`services/providerrelay.go:422-431, 313-316`
- **ç°çŠ¶**ï¼š
  ```go
  // forwardRequest è¿”å›å€¼åˆ¤æ–­
  if status >= 200 && status < 300 {
      return true, nil  // åªæœ‰ 2xx ç®—æˆåŠŸ
  }
  return false, fmt.Errorf("upstream status %d", status)  // å…¶ä»–å…¨éƒ¨å¤±è´¥

  // proxyHandler å¤„ç†å¤±è´¥
  if !ok {
      prs.blacklistService.RecordFailure(kind, firstProvider.Name)  // â† å…¨éƒ¨æ‹‰é»‘ï¼
  }
  ```
- **è¢«è¯¯æ‹‰é»‘çš„çŠ¶æ€ç **ï¼š
  - **400 Bad Request** â†’ å®¢æˆ·ç«¯å‚æ•°é”™è¯¯ï¼Œä¸æ˜¯ provider é—®é¢˜
  - **401 Unauthorized** â†’ ç”¨æˆ·é…ç½®çš„ API Key é”™è¯¯
  - **429 Too Many Requests** â†’ é™æµï¼Œå¾ˆå¿«ä¼šæ¢å¤
  - **403 Forbidden** â†’ æƒé™é—®é¢˜ï¼Œå¯èƒ½æ˜¯è´¦æˆ·é…é¢é—®é¢˜
- **å½±å“**ï¼š
  - å¥åº·çš„ provider å› å®¢æˆ·ç«¯é”™è¯¯è¢«è¯¯æ‹‰é»‘
  - é™æµå provider è¢«æ‹‰é»‘ï¼Œç”¨æˆ·åªèƒ½ç­‰å¾…æ‹‰é»‘è¿‡æœŸ
  - å¯ç”¨æ€§æ€¥å‰§ä¸‹é™
- **ä¿®å¤æ–¹å‘**ï¼š
  1. åŒºåˆ†"å¯é‡è¯•é”™è¯¯"å’Œ"ä¸å¯é‡è¯•é”™è¯¯"
  2. åªå¯¹ 5xxï¼ˆæœåŠ¡ç«¯é”™è¯¯ï¼‰å’Œç½‘ç»œè¶…æ—¶è®°å½•å¤±è´¥
  3. 4xx é”™è¯¯ç›´æ¥è¿”å›ç»™å®¢æˆ·ç«¯ï¼Œä¸è®¡å…¥é»‘åå•
  4. 429 å¯ä»¥å•ç‹¬å¤„ç†ï¼šçŸ­æš‚ç­‰å¾…åé‡è¯•ä¸‹ä¸€ä¸ª provider

### ğŸ”´ é»‘åå•è‡ªåŠ¨æ¢å¤"å‡æ¢å¤" â€”â€” ç­‰çº§æ°¸ä¹…ç´¯åŠ 
- **ä½ç½®**ï¼š`services/blacklistservice.go:617-620` å’Œ `210, 255, 278`
- **ç°çŠ¶**ï¼š
  ```go
  // æ¢å¤é€»è¾‘ï¼ˆä»…é‡ç½®éƒ¨åˆ†å­—æ®µï¼‰
  UPDATE provider_blacklist
  SET auto_recovered = 1, failure_count = 0  // â† åªé‡ç½®è¿™ä¸¤ä¸ªï¼
  WHERE platform = ? AND provider_name = ?

  // ä¸‹æ¬¡å¤±è´¥æ—¶çš„ç­‰çº§è®¡ç®—
  SELECT ... blacklist_level ...             // â† è¯»å–æ—§ç­‰çº§ï¼ˆä¾‹å¦‚ L3ï¼‰
  newLevel := blacklistLevel                 // â† 3
  levelIncrease := 1 æˆ– 2
  newLevel = blacklistLevel + levelIncrease  // â† 3 + 1 = 4
  ```
- **é—®é¢˜**ï¼š
  - Provider è¢«æ‹‰é»‘åˆ° L3 åï¼Œ`AutoRecoverExpired()` æ¢å¤æ—¶**ä¸æ¸…é›¶ `blacklist_level`**
  - ä¸‹æ¬¡å¤±è´¥æ—¶åœ¨æ—§ç­‰çº§åŸºç¡€ä¸Šç´¯åŠ ï¼š`L3 â†’ L4 â†’ L5`
  - ç­‰çº§æ°¸è¿œåªå‡ä¸é™ï¼Œæœ€ç»ˆé”å®šåœ¨ L5ï¼ˆ24 å°æ—¶æ‹‰é»‘ï¼‰
  - **"å‡æ¢å¤"**ï¼šè™½ç„¶ `auto_recovered=1`ï¼Œä½†ç­‰çº§æœªå½’é›¶ï¼Œprovider é•¿æœŸè¢«é«˜ç­‰çº§æƒ©ç½š
- **å®é™…å½±å“**ï¼š
  - å¶å°”ä¸ç¨³å®šçš„ provider ä¼šæ°¸ä¹…é™·å…¥ L5
  - ç”¨æˆ·å›°æƒ‘"ä¸ºä»€ä¹ˆæŸä¸ª provider æ€»æ˜¯è¢«æ‹‰é»‘å¾ˆä¹…"
- **ä¿®å¤æ–¹å‘**ï¼š
  ```go
  UPDATE provider_blacklist
  SET auto_recovered = 1,
      failure_count = 0,
      blacklist_level = 0,           // â† æ¸…é›¶ç­‰çº§ï¼
      last_recovered_at = ?          // â† è®°å½•æ¢å¤æ—¶é—´ï¼
  WHERE platform = ? AND provider_name = ?
  ```

## é«˜ä¼˜å…ˆçº§ï¼ˆåŠŸèƒ½ç¼ºé™·ï¼‰

### ğŸŸ§ æ—¥å¿—å†™å…¥å¯èƒ½ç›´æ¥ panic
- **ä½ç½®**ï¼š`services/providerrelay.go:352-381` å’Œ `684-706`
- **ç°çŠ¶**ï¼š
  ```go
  defer func() {
      err := GlobalDBQueueLogs.ExecBatchCtx(ctx, ...)  // æ— åˆ¤ç©ºï¼
  }()
  ```
  - å¦‚æœæ•°æ®åº“åˆå§‹åŒ–æ—¶åºé—®é¢˜ï¼ˆé˜»æ–­çº§é—®é¢˜ 1ï¼‰å¯¼è‡´ `GlobalDBQueueLogs` ä¸º nil
  - ç¬¬ä¸€æ¬¡è¯·æ±‚æ—¶ç›´æ¥ panic
- **ä¿®å¤æ–¹å‘**ï¼š
  1. ä¼˜å…ˆä¿®å¤é˜»æ–­çº§é—®é¢˜ 1
  2. é˜²å¾¡æ€§ç¼–ç¨‹ï¼šå†™å…¥å‰åˆ¤ç©º `if GlobalDBQueueLogs != nil`

### ğŸŸ¨ HTTP è¿æ¥æ³„æ¼
- **ä½ç½®**ï¼š`services/speedtestservice.go:94-95`
- **ç°çŠ¶**ï¼š
  ```go
  // çƒ­èº«è¯·æ±‚ï¼ˆå¿½ç•¥ç»“æœï¼Œç”¨äºå»ºç«‹è¿æ¥ï¼‰
  _, _ = s.makeRequest(client, parsedURL.String())  // å“åº”ä½“æœªå…³é—­ï¼
  ```
  - `makeRequest` è¿”å› `*http.Response`
  - çƒ­èº«è¯·æ±‚çš„å“åº”ä½“ä»æœªè¢« `Close()`
  - æ‰¹é‡å¹¶å‘æµ‹é€Ÿæ—¶ä¼šè€—å°½è¿æ¥æ± /æ–‡ä»¶å¥æŸ„
- **ä¿®å¤æ–¹å‘**ï¼š
  ```go
  if resp, _ := s.makeRequest(client, parsedURL.String()); resp != nil {
      io.Copy(io.Discard, resp.Body)
      resp.Body.Close()
  }
  ```

### ğŸŸ¦ Windows è‡ªå¯åŠ¨è·¯å¾„æœªåŠ å¼•å· â€”â€” Program Files ä¸‹å¤±æ•ˆ
- **ä½ç½®**ï¼š`services/autostartservice.go:67-78`
- **ç°çŠ¶**ï¼š
  ```go
  func (as *AutoStartService) enableWindows() error {
      exePath, err := os.Executable()
      // ...
      cmd := exec.Command("reg", "add", key, "/v", "CodeSwitch", "/t", "REG_SZ", "/d", exePath, "/f")
      //                                                                              â†‘ æœªåŠ å¼•å·ï¼
  }
  ```
- **å½±å“**ï¼š
  - å¦‚æœå®‰è£…åœ¨ `C:\Program Files\CodeSwitch\CodeSwitch.exe`
  - æ³¨å†Œè¡¨å†™å…¥ `C:\Program`ï¼ˆåœ¨ç©ºæ ¼å¤„è¢«æˆªæ–­ï¼‰
  - è‡ªå¯åŠ¨æ—¶ç³»ç»Ÿå°è¯•è¿è¡Œ `C:\Program`ï¼Œå¤±è´¥
  - ç”¨æˆ·å¯ç”¨è‡ªå¯åŠ¨ä½†å®é™…ä¸ç”Ÿæ•ˆ
- **ä¿®å¤æ–¹å‘**ï¼š
  ```go
  cmd := exec.Command("reg", "add", key, "/v", "CodeSwitch", "/t", "REG_SZ", "/d", "\""+exePath+"\"", "/f")
  ```

### ç­‰çº§æ‹‰é»‘å¼€å…³å§‹ç»ˆå¤±æ•ˆï¼ˆå›ºå®šæ¨¡å¼ï¼‰
- **ä½ç½®**ï¼š`services/blacklist_level_config.go:33-35` å’Œ `services/settingsservice.go:47-49`
- **ç°çŠ¶**ï¼š
  - `~/.code-switch/blacklist-config.json` ä¸å­˜åœ¨æ—¶è¿”å›é»˜è®¤é…ç½®
  - é»˜è®¤ `enableLevelBlacklist=false`ï¼Œæ°¸è¿œèµ° `recordFailureFixedMode`
  - å‰ç«¯åˆ‡æ¢å¼€å…³æœªè°ƒç”¨ `UpdateBlacklistLevelConfig` è½ç›˜
  - ç¼ºå°‘åç«¯å…œåº•å†™é»˜è®¤é…ç½®
- **è¯¦ç»†æ–¹æ¡ˆ**ï¼šè§ `doc/fix-blacklist-level-config-persistence.md`

### æ‰¹é‡é˜Ÿåˆ—ä¸æ–‡æ¡£ä¸ä¸€è‡´çš„é£é™©
- ä»£ç å½“å‰å¯ç”¨äº†åŒé˜Ÿåˆ—ï¼ˆå•æ¬¡ + request_log æ‰¹é‡ï¼‰ï¼Œè€Œæœ€æ–°æ–‡æ¡£æ›¾æ”¹ä¸ºé»˜è®¤ç¦ç”¨æ‰¹é‡
- éœ€æ˜ç¡®å®é™…æœŸæœ›ï¼šç»§ç»­æ‰¹é‡åˆ™åŒæ­¥æ–‡æ¡£ï¼›è‹¥ç¦ç”¨æ‰¹é‡åˆ™è°ƒæ•´ `InitGlobalDBQueue`

### å¯è§‚æµ‹æ€§ä¸è¶³
- å¯åŠ¨æœªæ‰“å°é»‘åå•é…ç½®æ¥æº/å¼€å…³çŠ¶æ€
- é˜Ÿåˆ—è¿è¡Œå¥åº·åº¦ç¼ºå°‘æŒç»­æ—¥å¿—ï¼Œæ’éšœå›°éš¾
- å»ºè®®å¯åŠ¨æ—¥å¿—æ‰“å°é…ç½®æ¥æºä¸çŠ¶æ€ï¼Œå®šæœŸè¾“å‡ºé˜Ÿåˆ—é•¿åº¦/å¤±è´¥ç‡

### SpeedTest ç«¯ç‚¹æ·»åŠ åæ— æ³•æŒä¹…åŒ–
- `frontend/src/components/SpeedTest/Index.vue` ä»…åœ¨å†…å­˜ç»´æŠ¤ `endpoints` åˆ—è¡¨
- åˆå§‹ç¡¬ç¼–ç  2 ä¸ª URLï¼›æ–°å¢/åˆ é™¤ä¸å†™å…¥åç«¯æˆ–æœ¬åœ°å­˜å‚¨ï¼Œåˆ·æ–°å³ä¸¢å¤±
- éœ€è¦å†³å®šæ•°æ®æºï¼ˆæœ¬åœ°å­˜å‚¨/åç«¯é…ç½®ï¼‰å¹¶æŒä¹…åŒ–

### é¦–é¡µä¾›åº”å•†å¡ç‰‡å‚ç›´å¯¹é½é—®é¢˜
- åé¦ˆ"Claude / Codex / Gemini å‡ ä¸ªåˆ—æ•´ä½“åä¸‹"
- éœ€æ£€æŸ¥é¦–é¡µå¡ç‰‡çš„ Flex å¸ƒå±€/è¡Œé«˜
- åˆæ­¥æ€€ç–‘ `frontend/src/components/Main/Index.vue` ä¸­ tab/å¡ç‰‡åŒºåŸŸçš„æ ·å¼éœ€è°ƒæ•´

### é»‘åå•å…³é—­æ—¶å¯èƒ½å‡ºç°æ­»å¾ªç¯/é˜»å¡
- å¤ç°çº¿ç´¢ï¼šå…³é—­æ‹‰é»‘ï¼ˆ`IsBlacklistEnabled=false`ï¼‰åä»æœ‰è°ƒç”¨æ–¹å¾ªç¯ç­‰å¾…å†™å…¥ç»“æœ
- ç–‘ä¼¼æŸå¤„æœªæå‰è¿”å›æˆ–æœªéµå®ˆ"å…³é—­å³è·³è¿‡å†™å…¥"çš„åˆ†æ”¯
- éœ€è¿›ä¸€æ­¥å®šä½è°ƒç”¨æ ˆä¸æ—¥å¿—

## ä¸­ä¼˜å…ˆçº§

### æ‰¹é‡/å•é˜Ÿåˆ—åˆå§‹åŒ–ä¸æ–‡æ¡£ä¸ä¸€è‡´
- ä»£ç å·²åˆ›å»ºåŒé˜Ÿåˆ—ï¼ˆå•æ¬¡+æ‰¹é‡ï¼‰
- è‹¥ç¯å¢ƒæœŸæœ›å…³é—­æ‰¹é‡ï¼Œéœ€è¦åŒæ­¥è°ƒæ•´ `InitGlobalDBQueue` ä¸æ—¥å¿—è¯´æ˜
- é¿å… request_log ä»èµ°æ‰¹é‡è·¯å¾„

### ç›‘æ§å¯è§‚æµ‹æ€§ä¸è¶³
- å¯åŠ¨æ—¶æœªæ‰“å°é»‘åå•é…ç½®æ¥æºã€å¼€å…³çŠ¶æ€
- é˜Ÿåˆ—çŠ¶æ€ä»…åœ¨å…³é—­æ—¶è¾“å‡º
- å»ºè®®å®šæœŸæˆ–æŒ‰è¯·æ±‚è®°å½•å…³é”®æŒ‡æ ‡

## å»ºè®®çš„ä¿®å¤é¡ºåº

### ç¬¬ä¸€ä¼˜å…ˆçº§ï¼ˆé˜»æ–­çº§ - å¿…é¡»é¦–å…ˆä¿®å¤ï¼‰
1. **åˆ›å»º SQLite çˆ¶ç›®å½•**ï¼šåœ¨ `xdb.Inits()` ä¹‹å‰è°ƒç”¨ `os.MkdirAll(~/.code-switch, 0755)`
2. **æ•°æ®åº“åˆå§‹åŒ–å‰ç§»**ï¼šå°† `xdb.Inits()` ç§»åˆ° `main()` æœ€å‰é¢ï¼Œåœ¨ä»»ä½•æœåŠ¡æ„é€ ä¹‹å‰å®Œæˆ
3. **ä¿®å¤é”™è¯¯å¤„ç†**ï¼š`NewSuiStore()` å¤±è´¥æ—¶é€€å‡ºæˆ–ä¸æ³¨å†Œ
4. **ä¿®å¤æ‹¼å†™é”™è¯¯**ï¼š`.codex-swtich` â†’ `.code-switch`
5. **æ„å»ºé—®é¢˜**ï¼šå¤„ç† `scripts/` å†²çªã€è¡¥é½ `frontend/dist` æˆ–æ·»åŠ æ„å»ºæ ‡ç­¾

### ç¬¬äºŒä¼˜å…ˆçº§ï¼ˆå®‰å…¨æ¼æ´ - ç´§æ€¥ä¿®å¤ï¼‰
6. **ä»£ç†æœåŠ¡ä»…ç›‘å¬ 127.0.0.1**ï¼šé˜²æ­¢ API Key åœ¨å±€åŸŸç½‘æš´éœ²
7. **SSRF é˜²æŠ¤**ï¼šæ·»åŠ åè®®ç™½åå•ã€IP é»‘åå•ã€ç«¯å£ç™½åå•
8. **è‡ªåŠ¨æ›´æ–°å®‰å…¨**ï¼šæ·»åŠ  SHA256 æ ¡éªŒã€ç”¨æˆ·ç¡®è®¤ã€å›æ»šæœºåˆ¶

### ç¬¬ä¸‰ä¼˜å…ˆçº§ï¼ˆæ ¸å¿ƒåŠŸèƒ½ - é«˜ä¼˜å…ˆçº§ï¼‰
9. **è¯·æ±‚è½¬å‘æ•…éšœåˆ‡æ¢**ï¼šå®ç°éå† Levelã€éå†åŒçº§ provider çš„é™çº§é€»è¾‘
10. **åŒºåˆ†å¯é‡è¯•é”™è¯¯**ï¼šåªå¯¹ 5xx å’Œè¶…æ—¶æ‹‰é»‘ï¼Œ4xx ç›´æ¥è¿”å›
11. **é»‘åå•å‡æ¢å¤**ï¼š`AutoRecoverExpired()` æ—¶æ¸…é›¶ `blacklist_level` å’Œè®°å½• `last_recovered_at`
12. **HTTP è¿æ¥æ³„æ¼**ï¼šä¿®å¤ speedtest çƒ­èº«è¯·æ±‚çš„å“åº”ä½“æœªå…³é—­
13. **Windows è‡ªå¯åŠ¨å¼•å·**ï¼šè·¯å¾„åŒ…å«ç©ºæ ¼æ—¶æ­£ç¡®å¤„ç†

### ç¬¬å››ä¼˜å…ˆçº§ï¼ˆç”¨æˆ·ä½“éªŒ - ä¸­ä¼˜å…ˆçº§ï¼‰
14. **ç­‰çº§æ‹‰é»‘é…ç½®æŒä¹…åŒ–**ï¼šå®ç°å¼€å…³è½ç›˜ä¸å…œåº•
15. **å¯è§‚æµ‹æ€§å¢å¼º**ï¼šå¯åŠ¨æ—¥å¿—ã€é˜Ÿåˆ—ç›‘æ§
16. **SpeedTest ç«¯ç‚¹æŒä¹…åŒ–**
17. **æ’æŸ¥é»‘åå•å…³é—­åæ­»å¾ªç¯**

---

**æ ¸å¿ƒä¿®å¤è·¯å¾„**ï¼ˆå»ºè®®æŒ‰æ­¤é¡ºåºï¼‰ï¼š
1. é˜»æ–­çº§ï¼ˆ1-5ï¼‰â†’ åº”ç”¨èƒ½æ­£å¸¸å¯åŠ¨
2. å®‰å…¨æ¼æ´ï¼ˆ6-8ï¼‰â†’ æ¶ˆé™¤ API Key æ³„éœ²å’Œ SSRF é£é™©
3. æ ¸å¿ƒåŠŸèƒ½ï¼ˆ9-13ï¼‰â†’ ä¿®å¤é™çº§é€»è¾‘å’Œé»‘åå•é€»è¾‘
4. ç”¨æˆ·ä½“éªŒï¼ˆ14-17ï¼‰â†’ å®Œå–„åŠŸèƒ½å’Œå¯è§‚æµ‹æ€§

---

**é—®é¢˜ç»Ÿè®¡**ï¼š
- é˜»æ–­çº§ï¼š4 ä¸ª
- é«˜ä¼˜å…ˆçº§ï¼ˆå®‰å…¨ï¼‰ï¼š3 ä¸ª
- é«˜ä¼˜å…ˆçº§ï¼ˆé€»è¾‘ï¼‰ï¼š4 ä¸ª
- é«˜ä¼˜å…ˆçº§ï¼ˆåŠŸèƒ½ï¼‰ï¼š9 ä¸ª
- ä¸­ä¼˜å…ˆçº§ï¼š2 ä¸ª
- **æ€»è®¡ï¼š22 ä¸ªé—®é¢˜**

---

ï¼ˆè®°å½•æ—¶é—´ï¼š2025-11-28ï¼Œæœ€åæ›´æ–°ï¼š2025-11-28 19:00ï¼‰
